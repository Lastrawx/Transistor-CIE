rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null
        && request.auth.token.admin == true;
    }

    function isValidStatus(status) {
      return status in [
        "nouveau",
        "lu",
        "devis_en_cours",
        "devis_envoye",
        "en_attente_client",
        "intervention_a_planifier",
        "facture_a_envoyer",
        "facture_envoyee",
        "termine",
        "rejete"
        ];
    }

    function isValidDevisShape(data) {
      return data.keys().hasOnly([
        "type",
        "createdAt",
        "updatedAt",
        "source",
        "profil",
        "service",
        "objet",
        "nom",
        "prenom",
        "email",
        "telephone",
        "preferenceRecontact",
        "message",
        "statut",
        "consentement",
        "website"
      ])
      && data.keys().hasAll([
        "type",
        "createdAt",
        "updatedAt",
        "source",
        "profil",
        "service",
        "objet",
        "nom",
        "prenom",
        "email",
        "telephone",
        "preferenceRecontact",
        "message",
        "statut",
        "consentement",
        "website"
      ]);
    }

    function isValidConsentEventShape(data) {
      return data.keys().hasOnly([
        "type",
        "source",
        "status",
        "context",
        "consentAuditId",
        "consentStorageKey",
        "policyVersion",
        "consentSchemaVersion",
        "pagePath",
        "clientRecordedAtMs",
        "recordedAt"
      ])
      && data.keys().hasAll([
        "type",
        "source",
        "status",
        "context",
        "consentAuditId",
        "consentStorageKey",
        "policyVersion",
        "consentSchemaVersion",
        "pagePath",
        "clientRecordedAtMs",
        "recordedAt"
      ])
      && data.type == "ads_cookie_consent"
      && data.source == "site-netlify"
      && data.status in ["granted", "denied", "unset"]
      && data.context in ["banner_accept", "banner_refuse", "footer_reset", "legacy_migration", "storage_sync"]
      && data.consentAuditId is string
      && data.consentAuditId.size() >= 12
      && data.consentAuditId.size() <= 64
      && data.consentStorageKey == "tc_ads_consent_v1"
      && data.policyVersion is string
      && data.policyVersion.size() >= 6
      && data.policyVersion.size() <= 32
      && data.consentSchemaVersion is string
      && data.consentSchemaVersion.size() >= 2
      && data.consentSchemaVersion.size() <= 8
      && data.pagePath is string
      && data.pagePath.size() >= 1
      && data.pagePath.size() <= 160
      && data.clientRecordedAtMs is int
      && data.clientRecordedAtMs > 0
      && data.recordedAt == request.time;
    }

    function hasValidNonNegativeMetricValue(data, key) {
      return !(key in data)
        || (
          data[key] is int
          && data[key] >= 0
          && data[key] <= 2000000000
        );
    }

    function isValidSiteMetricsShape(data) {
      return data.keys().hasOnly([
        "siteOpens",
        "totalClicks",
        "quoteClicks",
        "poleParticulierClicks",
        "poleEntrepriseClicks",
        "updatedAt"
      ])
      && data.updatedAt == request.time
      && hasValidNonNegativeMetricValue(data, "siteOpens")
      && hasValidNonNegativeMetricValue(data, "totalClicks")
      && hasValidNonNegativeMetricValue(data, "quoteClicks")
      && hasValidNonNegativeMetricValue(data, "poleParticulierClicks")
      && hasValidNonNegativeMetricValue(data, "poleEntrepriseClicks");
    }

    match /devis/{docId} {
      allow get, list, read: if isAdmin();

      allow create: if
        isValidDevisShape(request.resource.data)
        && request.resource.data.type == "devis"
        && request.resource.data.source == "site-netlify"
        && request.resource.data.createdAt == request.time
        && request.resource.data.updatedAt == request.time
        && request.resource.data.profil is string
        && request.resource.data.profil in ["particulier", "entreprise"]
        && request.resource.data.objet is string
        && request.resource.data.objet.size() >= 5
        && request.resource.data.objet.size() <= 200
        && request.resource.data.nom is string
        && request.resource.data.nom.size() >= 1
        && request.resource.data.nom.size() <= 100
        && request.resource.data.prenom is string
        && request.resource.data.prenom.size() >= 1
        && request.resource.data.prenom.size() <= 100
        && request.resource.data.service is string
        && request.resource.data.service.size() <= 160
        && request.resource.data.telephone is string
        && request.resource.data.telephone.size() <= 30
        && request.resource.data.telephone.matches('^$|^[0-9+(). -]{6,25}$')
        && request.resource.data.preferenceRecontact is string
        && request.resource.data.preferenceRecontact in ["mail", "appel", "sms", "whatsapp"]
        && (
          request.resource.data.telephone == ""
            ? request.resource.data.preferenceRecontact == "mail"
            : true
        )
        && request.resource.data.email is string
        && request.resource.data.email.size() >= 5
        && request.resource.data.email.size() <= 200
        && request.resource.data.email.matches('^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$')
        && request.resource.data.message is string
        && request.resource.data.message.size() >= 20
        && request.resource.data.message.size() <= 3000
        && request.resource.data.statut == "nouveau"
        && request.resource.data.consentement is bool
        && request.resource.data.consentement == true
        && request.resource.data.website == "";

      allow update: if
        isAdmin()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(["statut", "updatedAt"])
        && request.resource.data.statut is string
        && isValidStatus(request.resource.data.statut)
        && request.resource.data.updatedAt == request.time;

      allow delete: if isAdmin();
    }

    match /consent_events/{docId} {
      allow get, list, read, update, delete: if isAdmin();

      allow create: if isValidConsentEventShape(request.resource.data);
    }

    match /site_metrics/{docId} {
      allow get, list, read: if isAdmin();

      allow create, update: if
        docId == "global"
        && isValidSiteMetricsShape(request.resource.data);

      allow delete: if isAdmin();
    }
  }
}
